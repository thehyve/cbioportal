<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cbioportal.persistence.mybatis.AlterationMapper">

    <select id="getSampleCountInMultipleMolecularProfiles" resultType="org.cbioportal.model.AlterationCountByGene">
        SELECT ENTREZ_GENE_ID AS entrezGeneId, HUGO_GENE_SYMBOL AS hugoGeneSymbol, COUNT(*) AS totalCount, COUNT(DISTINCT(SAMPLE_ID)) AS numberOfAlteredCases FROM
        (
        SELECT sample_profile.SAMPLE_ID, mutation.ENTREZ_GENE_ID, gene.HUGO_GENE_SYMBOL, mutation_event.MUTATION_TYPE as alteration, sample_profile.GENETIC_PROFILE_ID
        FROM sample_profile
        inner join mutation ON sample_profile.SAMPLE_ID = mutation.SAMPLE_ID
        INNER JOIN gene ON mutation.ENTREZ_GENE_ID = gene.ENTREZ_GENE_ID
        INNER JOIN mutation_event on mutation.MUTATION_EVENT_ID = mutation_event.MUTATION_EVENT_ID
        UNION
        SELECT sample_profile.SAMPLE_ID, cna_event.ENTREZ_GENE_ID , gene.HUGO_GENE_SYMBOL, cna_event.ALTERATION as alteration, sample_profile.GENETIC_PROFILE_ID
        FROM sample_profile 
        inner join sample_cna_event ON sample_profile.SAMPLE_ID = sample_cna_event.SAMPLE_ID
        inner join cna_event on cna_event.CNA_EVENT_ID = sample_cna_event.CNA_EVENT_ID
        INNER JOIN gene ON cna_event.ENTREZ_GENE_ID = gene.ENTREZ_GENE_ID
        ) as JoinedTable 
        WHERE
        <if test="sampleIds != null and !sampleIds.isEmpty()">
            JoinedTable.SAMPLE_ID IN (
            SELECT sample.INTERNAL_ID from sample
            INNER JOIN patient ON sample.PATIENT_ID = patient.INTERNAL_ID
            INNER JOIN genetic_profile ON patient.CANCER_STUDY_ID = genetic_profile.CANCER_STUDY_ID
            WHERE 
            <if test="@java.util.Arrays@stream(molecularProfileIds.toArray()).distinct().count() == 1">
                genetic_profile.STABLE_ID = #{molecularProfileIds[0]} AND
                sample.STABLE_ID IN
                <foreach item="item" collection="sampleIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="@java.util.Arrays@stream(molecularProfileIds.toArray()).distinct().count() > 1">
                (sample.STABLE_ID, genetic_profile.STABLE_ID) IN
                <foreach index="i" collection="sampleIds" open="(" separator="," close=")">
                    (#{sampleIds[${i}]}, #{molecularProfileIds[${i}]})
                </foreach>
                AND genetic_profile.STABLE_ID IN
                <foreach item="item" collection="molecularProfileIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </if>
        <if test="entrezGeneIds != null and alterations != null">
            AND (JoinedTable.ENTREZ_GENE_ID, JoinedTable.ALTERATION) IN
            <foreach index="i" collection="entrezGeneIds" open="(" separator="," close=")">
                (#{entrezGeneIds[${i}]}, #{alterations[${i}]})
            </foreach>
        </if>
        <if test="entrezGeneIds != null and alterations == null">
            AND JoinedTable.ENTREZ_GENE_ID IN
            <foreach item="entrezGeneId" collection="entrezGeneIds" open="(" separator="," close=")">
                #{entrezGeneId}
            </foreach>
        </if>
        <if test="entrezGeneIds == null and alterations != null">
            AND JoinedTable.ALTERATION IN
            <foreach item="alteration" collection="alterations" open="(" separator="," close=")">
                #{alteration}
            </foreach>
        </if>
        )
        GROUP BY ENTREZ_GENE_ID, HUGO_GENE_SYMBOL;
    </select>

    <select id="getPatientCountInMultipleMolecularProfiles" resultType="org.cbioportal.model.AlterationCountByGene">
        SELECT ENTREZ_GENE_ID AS entrezGeneId, HUGO_GENE_SYMBOL AS hugoGeneSymbol, COUNT(*) AS totalCount, COUNT(DISTINCT(PATIENT_ID)) AS numberOfAlteredCases, STABLE_ID FROM
        (
        SELECT patient.STABLE_ID as PATIENT_ID, mutation.ENTREZ_GENE_ID, gene.HUGO_GENE_SYMBOL, mutation_event.MUTATION_TYPE as alteration, genetic_profile.STABLE_ID
        FROM sample_profile
        inner join mutation ON sample_profile.SAMPLE_ID = mutation.SAMPLE_ID
        INNER JOIN gene ON mutation.ENTREZ_GENE_ID = gene.ENTREZ_GENE_ID
        INNER JOIN mutation_event on mutation.MUTATION_EVENT_ID = mutation_event.MUTATION_EVENT_ID
        INNER JOIN genetic_profile on sample_profile.GENETIC_PROFILE_ID = genetic_profile.GENETIC_PROFILE_ID
        INNER JOIN sample ON sample_profile.SAMPLE_ID = sample.INTERNAL_ID
        INNER JOIN patient ON sample.PATIENT_ID = patient.INTERNAL_ID
        UNION
        SELECT patient.STABLE_ID as PATIENT_ID, cna_event.ENTREZ_GENE_ID , gene.HUGO_GENE_SYMBOL, cna_event.ALTERATION as alteration, genetic_profile.STABLE_ID
        FROM sample_profile 
        inner join sample_cna_event ON sample_profile.SAMPLE_ID = sample_cna_event.SAMPLE_ID
        inner join cna_event on cna_event.CNA_EVENT_ID = sample_cna_event.CNA_EVENT_ID
        INNER JOIN gene ON cna_event.ENTREZ_GENE_ID = gene.ENTREZ_GENE_ID
        INNER JOIN genetic_profile on sample_profile.GENETIC_PROFILE_ID = genetic_profile.GENETIC_PROFILE_ID
        INNER JOIN sample ON sample_profile.SAMPLE_ID = sample.INTERNAL_ID
        INNER JOIN patient ON sample.PATIENT_ID = patient.INTERNAL_ID
        ) as JoinedTable
        WHERE
        <if test="patientIds != null and !patientIds.isEmpty()">
            <if test="@java.util.Arrays@stream(molecularProfileIds.toArray()).distinct().count() == 1">
                JoinedTable.STABLE_ID = #{molecularProfileIds[0]}
                AND PATIENT_ID IN
                <foreach item="item" collection="patientIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="@java.util.Arrays@stream(molecularProfileIds.toArray()).distinct().count() > 1">
                (PATIENT_ID, JoinedTable.STABLE_ID) IN
                <foreach index="i" collection="patientIds" open="(" separator="," close=")">
                      (#{patientIds[${i}]}, #{molecularProfileIds[${i}]})
                </foreach>
                AND JoinedTable.STABLE_ID IN
                <foreach item="item" collection="molecularProfileIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </if>
		<if test="patientIds == null">
		    JoinedTable.STABLE_ID IN
			<foreach item="item" collection="molecularProfileIds" open="(" separator="," close=")">
			    #{item}
			</foreach>
		</if>
        <if test="entrezGeneIds != null and !entrezGeneIds.isEmpty()">
            AND mutation.ENTREZ_GENE_ID IN
            <foreach item="item" collection="entrezGeneIds" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="snpOnly != null and snpOnly == true">
            AND mutation_event.REFERENCE_ALLELE IN ('A','T','C','G')
            AND mutation_event.TUMOR_SEQ_ALLELE IN ('A','T','C','G')
        </if>
        GROUP BY ENTREZ_GENE_ID, HUGO_GENE_SYMBOL, STABLE_ID;
    </select>
</mapper>
